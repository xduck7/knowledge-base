# Best Practices Terraform

## Общие принципы

- Всегда хранить конфигурацию в системе контроля версий (Git).  
- Разделять инфраструктуру на модули, чтобы повторно использовать код и упрощать поддержку.  
- Использовать переменные для конфигурируемых значений, а не «жёсткие» константы.  
- Фиксировать версии Terraform и провайдеров для стабильности.  

---

## Организация файлов

- Разделять `.tf` файлы по смыслу:
  - `main.tf` — основные ресурсы  
  - `variables.tf` — переменные  
  - `outputs.tf` — выходные значения  
  - `providers.tf` — провайдеры  
  - `backend.tf` — конфигурация backend  
- Использовать `.tfvars` для конкретных окружений.  

---

## Управление состоянием

- Использовать удалённые backend для командной работы (`s3`, `azurerm`, `gcs`).  
- Настроить блокировки состояния, чтобы избежать race conditions.  
- Разделять состояния по окружениям: workspaces или отдельные каталоги.  

---

## Работа с модулями

- Разделять инфраструктуру на небольшие, изолированные модули.  
- Версионировать внешние модули и фиксировать версии (`version` или Git ref).  
- Документировать входные переменные и outputs для удобства использования.  

---

## Переменные и outputs

- Указывать типы переменных (`string`, `number`, `bool`, `list`, `map`).  
- Присваивать sane defaults для переменных, если это безопасно.  
- Ограничивать чувствительные значения через `sensitive = true`.  
- Выходные значения использовать для передачи данных между модулями или окружениями.  

---

## Безопасность

- Никогда не хранить секреты в коде или `.tfvars` файлах без шифрования.  
- Использовать инструменты типа SOPS, Vault или External Secrets для управления конфиденциальными данными.  
- Минимизировать права пользователей, используемых Terraform, до необходимых ресурсов.  

---

## CI/CD и инфраструктура как код

- Проверять конфигурации через `terraform fmt` и `terraform validate`.  
- Настраивать планирование изменений (`terraform plan`) перед применением (`terraform apply`).  
- Автоматизировать lint и тесты модулей.  
- Ревью кода обязательно для изменений инфраструктуры.  

---

## Управление окружениями

- Разделять dev/stage/prod через каталоги или workspaces.  
- Использовать разные backend/states для изоляции окружений.  
- Применять одинаковые модули и конфигурации для всех окружений, меняя только параметры.

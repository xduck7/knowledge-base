# Workspaces и управление окружениями в Terraform

## Что такое workspace

Workspace в Terraform — это изолированная рабочая область, которая использует один и тот же набор конфигураций, но отдельное состояние (`terraform.tfstate`).  
По сути, workspace позволяет иметь несколько параллельных сред с одинаковым кодом, но разными ресурсами.

---

## Отличие workspaces от отдельных стейтов/каталогов

| Подход | Описание | Плюсы | Минусы |
|--------|----------|-------|--------|
| Workspaces | Один набор `.tf` файлов, несколько workspace (`default`, `dev`, `prod`) | Лёгкое переключение сред (`terraform workspace select`), единый код | Не всегда удобно при сложной инфраструктуре, легко перепутать workspace |
| Отдельные каталоги/стейты | Каждый env имеет отдельный каталог с копией `.tf` файлов | Полная изоляция, простая интеграция с CI/CD | Дублирование кода, сложнее поддерживать синхронизацию изменений |

---

## Использование workspaces

Простейшие команды:

```sh
terraform workspace list      # список всех workspace
terraform workspace new dev   # создать новый workspace
terraform workspace select dev # переключиться на workspace
terraform workspace show      # текущий workspace
````

Работа с ресурсами зависит от текущего workspace:

```hcl
resource "aws_s3_bucket" "example" {
  bucket = "my-bucket-${terraform.workspace}"
}
```

* В workspace `dev` bucket будет `my-bucket-dev`
* В workspace `prod` bucket будет `my-bucket-prod`

---

## Паттерн каталогов для окружений

Для больших проектов часто используют комбинацию каталогов и workspaces:

```
environments/
├── dev/
│   └── main.tf
├── stage/
│   └── main.tf
└── prod/
    └── main.tf
modules/
├── vpc/
└── app/
```

* Каталоги разделяют конфигурацию на физические окружения.
* Внутри каталога можно использовать workspace, если требуется несколько вариантов (например, `feature-branch` тесты).
* Обычно `dev`, `stage`, `prod` отражают lifecycle окружений.

---

## Когда использовать workspaces

* Несколько идентичных окружений с небольшими различиями (dev/test/prod) и одним набором кода.
* Для быстрого переключения между средами в CI/CD пайплайнах.
* Для feature-branch инфраструктуры или временных стендов.

---

## Когда использовать отдельные каталоги или стейты

* Сложные окружения с сильно отличающейся инфраструктурой.
* Когда требуется полная изоляция и независимый lifecycle ресурсов.
* Для долгоживущих prod-окружений с высокими требованиями к безопасности и versioning.

---

## Итог

* Workspaces позволяют управлять несколькими версиями состояния на основе одного кода.
* Для небольших или идентичных окружений — workspace упрощает работу.
* Для сложных и критичных окружений лучше использовать отдельные каталоги/стейты.
* Часто комбинируют подходы: каталоги `environments/{dev,stage,prod}` + workspace для временных тестовых веток.

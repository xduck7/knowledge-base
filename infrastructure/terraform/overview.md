# Overview

## Что такое Terraform

Terraform — это инструмент от HashiCorp для управления инфраструктурой как кодом (IaC: Infrastructure as Code).  
Он позволяет описывать нужную инфраструктуру в конфигурационных файлах, а затем автоматически создавать, изменять и удалять реальные ресурсы так, чтобы они соответствовали этому описанию.  

Terraform умеет работать с разными провайдерами: общедоступные и частные облака, Kubernetes, DNS, базы данных, очереди, SaaS‑сервисы и т.д.  
Одна и та же модель конфигурации используется и для создания инфраструктуры с нуля, и для её дальнейшей эволюции.  

---

## IaC и декларативная модель

Infrastructure as Code — это подход, при котором инфраструктура описывается текстовыми файлами, а не кликами в консолях и ручными командами.  
Terraform реализует IaC в декларативном стиле: в конфигурации описывается **желаемое состояние**, а не последовательность шагов для его получения.  

Схема работы:

1. Ты описываешь ресурсы в `.tf` файлах (что должно быть: сети, ВМ, БД, Kubernetes‑ресурсы).  
2. `terraform plan` вычисляет разницу между желаемым состоянием и тем, что реально существует.  
3. `terraform apply` применяет изменения, вызывая API провайдеров, пока реальная инфраструктура не станет совпадать с конфигом.  

Преимущества:

- повторяемость (те же файлы дают тот же результат в разных окружениях);  
- контроль версий и code review (конфиги лежат в Git);  
- предсказуемые изменения (план перед применением).  

---

## Провайдеры

Провайдер — это плагин Terraform, который знает, как говорить с конкретным API.  
Через провайдеры Terraform умеет управлять:

- облаками (AWS, GCP, Azure, Yandex Cloud и т.д.);  
- Kubernetes‑кластерами;  
- DNS‑провайдерами (Cloudflare, Route53 и др.);  
- базами данных, очередями, CDN, мониторингом, SaaS‑сервисами.  

В конфиге это выглядит так:

```tf
terraform {
  required_providers {
    aws = {
      source  = "hashicorp/aws"
      version = "~> 5.0"
    }
  }
}

provider "aws" {
  region = "eu-central-1"
}
```

Каждый провайдер описывает свои `resource` и `data` типы (например, `aws_instance`, `kubernetes_deployment`, `postgresql_database`), а Terraform оркестрирует их создание и обновление.  

---

## Граф зависимостей

Одно из ключевых отличий Terraform — он строит граф зависимостей всех ресурсов.  
Из этого графа он автоматом понимает:

- что можно создавать параллельно;  
- что зависит от чего и должно идти позже;  
- в каком порядке безопасно удалять ресурсы.  

Например:

```tf
resource "aws_vpc" "main" { ... }

resource "aws_subnet" "public" {
  vpc_id = aws_vpc.main.id
  ...
}

resource "aws_instance" "app" {
  subnet_id = aws_subnet.public.id
  ...
}
```

Terraform видит зависимости по обращениям к атрибутам (`aws_subnet.public` ссылается на `aws_vpc.main`, `aws_instance.app` — на `aws_subnet.public`).  
На основе этого он строит DAG и сначала создаёт VPC, потом subnet, потом instance, а при удалении — в обратном порядке.  

Граф используется:

- для вычисления плана;  
- для параллельного выполнения независимых операций;  
- для минимальных, точечных изменений при `apply`.  

---

## Основные use‑cases

### Облака (IaaS/PaaS)

Классический сценарий — управление облачной инфраструктурой:

- сети, подсети, маршруты, security groups / firewall‑правила;  
- виртуальные машины, managed Kubernetes, load balancer’ы;  
- базы данных (RDS/Cloud SQL/Managed DB), очереди, хранилища, CDN.  

Terraform позволяет:

- описать целый cloud‑стек в коде;  
- воспроизводить его в разных регионах/аккаунтах;  
- делать промо окружений (dev → stage → prod) через одинаковые модули, меняя только `variables`.  

### Kubernetes

Terraform можно использовать и поверх Kubernetes (как альтернатива/дополнение к Helm):

- создавать кластера (через cloud‑провайдеры);  
- управлять самим кластером и его ресурсами через `kubernetes` провайдер;  
- комбинировать: кластер + сетка + внешние БД/очереди в одном плане.  

Частый паттерн:

- Terraform создаёт инфраструктурный фундамент (VPC, K8s‑кластер, БД, load balancer’ы);  
- Helm отвечает за деплой приложений **внутри** кластера.  

### Базы данных и сетка

Через соответствующие провайдеры Terraform может:

- создавать инстансы БД (managed PostgreSQL/MySQL/ClickHouse и т.п.);  
- настраивать параметры (размер, класс, backup‑политику, репликацию);  
- выдавать пользователям и приложениям базы/пользователей/правила доступа (иногда в связке с Vault для динамических кредов).  

Для сети:

- VPC/VNet, подсети, маршруты, NAT;  
- VPN/peering между сетями и аккаунтами;  
- DNS‑записи (например, Route53/Cloudflare) на основе IP/hostname’ов созданных ресурсов.  

### Другие сценарии

Terraform также применяют для:

- управления аккаунтами и IAM‑политиками;  
- интеграции с мониторингом/логированием (оповещения, дашборды, alert‑policy);  
- управления SaaS (GitHub/GitLab, Cloudflare, Datadog, New Relic, Kafka‑кластера и т.д.).  

---

## Почему Terraform удобен бэкендеру

- Устраняет «магический» прод: всё описано в коде рядом с сервисами, можно прочитать и понять, как живёт прод.  
- Легко поднимать новые окружения (от локальных стендов до ephemeral env для фич) из тех же модулей, что и прод.  
- Встраивается в обычный инженерный флоу: Git, review, CI/CD, тесты / `terraform validate`, `plan` как часть MR/PR.

# Модули Terraform

## Что такое модуль

Модуль в Terraform — это набор конфигураций (`.tf` файлов), который можно использовать повторно.  
Любая конфигурация Terraform является модулем, но чаще под «модулем» понимают отдельный, переиспользуемый блок с ресурсами, переменными и выходными значениями.

---

## Зачем использовать модули

- Повторное использование кода между проектами и окружениями  
- Разделение инфраструктуры на логические компоненты  
- Стандартизация ресурсов и best practices  
- Упрощение сопровождения и тестирования  

---

## Локальные и внешние модули

### Локальные модули

Хранятся внутри проекта:

```

project/
├── main.tf
├── modules/
│   └── vpc/
│       ├── main.tf
│       ├── variables.tf
│       └── outputs.tf

````

Использование локального модуля:

```hcl
module "vpc" {
  source = "./modules/vpc"
  cidr_block = "10.0.0.0/16"
  public_subnets = ["10.0.1.0/24", "10.0.2.0/24"]
}
````

* `source` указывает путь к модулю.
* Модуль принимает входные переменные и возвращает outputs.

---

### Внешние модули

Хранятся вне проекта, например, в Terraform Registry или Git:

```hcl
module "consul" {
  source  = "hashicorp/consul/aws"
  version = "0.8.0"
  servers = 3
}
```

* `source` может быть:

  * `registry.terraform.io/<namespace>/<name>/<provider>`
  * Git URL: `git::https://github.com/org/repo.git//path/to/module?ref=v1.2.0`
* `version` фиксирует версию внешнего модуля для стабильности.

---

## Структура модуля

Стандартная структура:

```
module/
├── main.tf        # ресурсы
├── variables.tf   # входные переменные
├── outputs.tf     # выходные значения
├── README.md      # документация
└── examples/      # примеры использования
```

* `main.tf` содержит ресурсы и блоки data.
* `variables.tf` описывает все входные параметры с типами и дефолтами.
* `outputs.tf` возвращает важные значения (ID, адреса, URL).
* `examples/` помогает новым пользователям быстро понять, как применять модуль.

---

## Переиспользование (reuse)

Модуль можно использовать несколько раз с разными параметрами:

```hcl
module "vpc_dev" {
  source        = "./modules/vpc"
  cidr_block    = "10.0.0.0/16"
  environment   = "dev"
}

module "vpc_prod" {
  source        = "./modules/vpc"
  cidr_block    = "10.1.0.0/16"
  environment   = "prod"
}
```

* Один и тот же модуль создаёт разные окружения без дублирования кода.

---

## Версионирование модулей

* Для внешних модулей использовать `version` или Git ref (`tag`, `branch`, `commit`).
* Для локальных модулей — фиксировать состояние кода через Git и CI/CD пайплайны.
* Смена версии модуля в `terraform init -upgrade` обновляет код, сохраняя обратную совместимость.

---

## Итог

* Модуль — это изолированный блок конфигурации для повторного использования.
* Существует локальные и внешние модули.
* Структура: `main.tf`, `variables.tf`, `outputs.tf`, `README.md`, `examples/`.
* Использование модулей упрощает поддержку, стандартизацию и разделение инфраструктуры на компоненты.
* Версионирование обеспечивает стабильность при апгрейдах.

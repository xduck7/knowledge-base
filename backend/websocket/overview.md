# WebSocket: протокол и API

## 1. Протокол WebSocket (RFC 6455)

WebSocket описан в RFC 6455 и работает поверх TCP, устанавливая одно долговременное соединение между клиентом и сервером. 
В отличие от HTTP с моделью «запрос‑ответ», WebSocket обеспечивает полнодуплексный обмен: обе стороны могут отправлять данные в любой момент.

### Рукопожатие и апгрейд с HTTP

Соединение начинается с обычного HTTP‑запроса `GET` со специальными заголовками `Upgrade: websocket` и `Connection: Upgrade`. 
Клиент также отправляет `Sec-WebSocket-Key` и версию протокола, а сервер в ответ возвращает `101 Switching Protocols` и `Sec-WebSocket-Accept`, подтверждая переход на WebSocket.

Пример фрагмента запроса:

```
GET /chat HTTP/1.1
Host: example.com
Upgrade: websocket
Connection: Upgrade
Sec-WebSocket-Key: x3JJHMbDL1EzLkh9GBhXDw==
Sec-WebSocket-Version: 13
Origin: https://example.com
```

### Фреймы и типы данных

После установления соединения данные передаются в виде фреймов — небольших сообщений, идущих по одному TCP‑соединению. 
Фреймы бывают текстовыми (обычно UTF‑8) и бинарными, а также служебными (ping, pong, close).

Клиент периодически может отправлять `ping`, а сервер отвечает `pong`, что помогает поддерживать соединение и обнаруживать разрыв.
Закрытие соединения происходит через специальные фреймы `Close` с кодом причины; после обмена такими фреймами обе стороны закрывают TCP‑соединение.

---

## 2. WebSocket API в браузере

В браузерах WebSocket доступен через встроенный объект `WebSocket` с URL на схеме `ws://` или `wss://` (шифрованный вариант).
В большинстве современных браузеров поддерживается как небезопасный `ws`, так и `wss`, который использует TLS и аналогичен HTTPS. 

### Создание соединения и события

Создание соединения:

```js
const socket = new WebSocket('wss://example.com/chat');
```

У объекта `WebSocket` есть четыре ключевых события: `open`, `message`, `error`, `close`.

```js
socket.onopen = () => {
socket.send('hello');
};

socket.onmessage = (event) => {
console.log('message:', event.data);
};

socket.onerror = (err) => {
console.error('ws error', err);
};

socket.onclose = (event) => {
console.log('closed', event.code, event.reason);
};
```

Для отправки данных используется метод `send()`, который принимает строки или бинарные данные (например, `ArrayBuffer`). 
Типичных состояний соединения четыре: `CONNECTING (0)`, `OPEN (1)`, `CLOSING (2)`, `CLOSED (3)`, доступных через `socket.readyState`.

### Subprotocols и extensions

Клиент может запросить один или несколько подпротоколов (например, `json`, `graphql-ws`) через заголовок `Sec-WebSocket-Protocol`.
Сервер выбирает один подпротокол и подтверждает его в ответе, после чего обе стороны общаются в рамках этого логического протокола.

Расширения (extensions), такие как сжатие сообщений (`permessage-deflate`), также согласовываются на этапе рукопожатия и влияют на то, как кодируются фреймы. 

### Ограничения по Origin и безопасность

Браузер отправляет заголовок `Origin`, и сервер может использовать его для проверки домена, с которого устанавливается соединение.
Рекомендуется явно проверять `Origin` на сервере и использовать `wss` в продакшене, чтобы защититься от MITM и недоверенных фронтендов.
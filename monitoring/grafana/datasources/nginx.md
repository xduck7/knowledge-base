# Nginx как источник метрик

## Общая модель: метрики как производные от статуса сервера

Nginx сам по себе не генерирует структурированные метрики. Он предоставляет **сырые показатели состояния** через `stub_status` или расширенные статусы в сторонних модулях. Эти данные отражают моментальный снимок работы сервера:

* активные соединения;
* обработанные запросы;
* текущее состояние воркеров;
* счётчики чтения/записи.

Это не временные ряды. Для наблюдаемости их превращает в метрики внешний компонент — экспортер.

Упрощённый фрагмент ответа `stub_status`:

```s
Active connections: 291 
server accepts handled requests
 1024 1024 2048 
Reading: 12 Writing: 17 Waiting: 262
```

Для системы мониторинга это просто текст с числами. Метрики появляются после парсинга экспортером.

## Как данные выходят наружу

Nginx публикует служебную страницу `/status` или `/stub_status`. Экспортер делает периодические запросы, анализирует ответ, конвертирует в формат Prometheus. Путь простой:

1. Nginx отдаёт статус в текстовом виде.
2. Экспортер запрашивает и парсит этот статус.
3. Экспортер публикует метрики для Prometheus.
4. Grafana отображает уже привычные временные ряды.

Nginx не хранит историю, не делает агрегаций и не имеет нативного API для метрик.

## Роль nginx-exporter

nginx-exporter — это преобразователь статуса в метрики Prometheus. Он отвечает за:

* формирование `nginx_connections_active`,
* счётчики обработанных запросов,
* распределение состояний воркеров,
* конструкторы метрик uptime и ошибок.

Экспортер ничего не знает о внутренней структуре запросов, он работает только с публичным статусом Nginx.

Пример обозначений, которые появляются после парсинга:

* `nginx_connections_active`
* `nginx_connections_reading`
* `nginx_connections_writing`
* `nginx_connections_waiting`
* `nginx_http_requests_total`

Grafana использует это как обычные Prometheus-метрики.

## Метрики самого экспортера

Экспортер публикует и собственные служебные показатели:

* ошибки парсинга;
* время опроса;
* количество успешных выборок статуса.

Это мониторинг экспортера как сервиса, а не самого Nginx, но важно для понимания качества данных.

## Корреляция метрик Nginx с остальными источниками

Nginx — внешняя оболочка запросов. Его показатели обычно коррелируются с:

* метриками приложений дальше по цепочке;
* трейсовыми системами, которые дают детализацию каждого запроса;
* логами, где сохраняются конкретные строки доступа.

Метрики экспортера дают агрегированное состояние — сколько соединений, как часто происходят запросы, где узкое место. Дальнейший анализ продолжается в трейсах и логах, чтобы разложить проблему по слоям.
